var Trade=(function(my){let $t,$get_id,$send_id,$get_child_id,$send_child_id,$rate;let get_id=0,send_id=0,get_child_id=0,send_child_id=0;let data,rates,rate,min,max,$btn_submit,$overlay;let $amount_send,$amount_get;let timer,timerId;exchange_timer=function(){let i=Number(timer_i.text());let s=Number(timer_s.text());s--;if(s<0){s=59;i--}
if(i<0){clearInterval(timerId);document.location.reload();return}
timer_i.text(i);timer_s.text(s)}
exchange_proccess=function(){timer=$('#exchange_timer');if(timer.length){timer_i=timer.find('.minute');timer_s=timer.find('.second');timerId=setInterval(exchange_timer,1000)}}
is_float=function(v){return String(parseFloat(v,10))===String(v)}
set_ids_form=function(){$send_id.val(send_id);$get_id.val(get_id);$send_child_id.val(send_child_id);$get_child_id.val(get_child_id)}
get_amount_send=function(){return parseFloat($amount_send.val().replace(/ /g,''))}
get_amount_get=function(){return parseFloat($amount_get.val().replace(/ /g,''))}
set_amount_get=function(v){v=formatMoney(v,$amount_get.data('decimals'),'.',' ',!0)
$amount_get.val(v)}
set_amount_send=function(v){v=formatMoney(v,$amount_send.data('decimals'),'.',' ',!0)
$amount_send.val(v)}
get_rates=function(){$.getJSON('/?get_rates',function(d){rates=d.rates;data=d.data;update()}).always(function(){setTimeout(get_rates,10000)})}
recalc_data=function(){let rs=rates[send_child_id?send_child_id:send_id];let rg=rates[get_child_id?get_child_id:get_id];let s=send_child_id?data[send_id].childs[send_child_id]:data[send_id];let g=get_child_id?data[get_id].childs[get_child_id]:data[get_id];if(typeof s==='undefined'||typeof g==='undefined')return;$amount_send.data('decimals',s.decimals).attr('decimals',s.decimals);$amount_get.data('decimals',g.decimals).attr('decimals',g.decimals);let rate_final=rs.rate||rs.rate_parse;rate=Number(formatMoney(rate_final/rg.rate_calc,10,'.',''));let rate_v=rate;if(rate>=1){}else if(rate<0.5){rate_v=1/rate}else{rate_v=rate*100}
rate_v=Number(rate_v.toFixed(2));if(rate_v>100000)rate_v=Math.round(rate_v);let rate_=n(formatMoney(rate_v,g.decimals,'.',' '));if(rate>=1){rate=rate_v;$('.rate_info').text('1 '+s.cur+' = '+rate_+' '+g.cur)}else if(rate<0.5){rate=1/rate_v;$('.rate_info').text(rate_+' '+s.cur+' = 1 '+g.cur)}else{rate=rate_v/100;$('.rate_info').text('100 '+s.cur+' = '+rate_+' '+g.cur)}
$rate.val(rate);min=0;if(s.min>0){min=s.min}else if(s.min_d>0){min=s.min_d/rs.rate_calc}
min=parseFloat(min);let min_=n(formatMoney(min,s.decimals,'.',' '));$('.send_min').text(min_+' '+s.cur);max=0;if(s.max>0){max=s.max}
max=parseFloat(max);let max_=formatMoney(max,2,'.',' ');$('.send_max').text(max_+' '+s.cur);$('.get_reserves span').text(n(rg.reserve)+' '+g.cur);$amount_send.trigger('input')}
update=function(){update_fields_send(send_id);update_fields_recive(get_id);setTimeout(function(){$amount_send.trigger('blur')},50);recalc_data()}
submit_form=function(){let fd=$t.serialize();$overlay.show();$.ajax({url:$t.attr('action'),data:fd}).always(function(){$overlay.hide()}).done(function(res){if(res.error){error(res.error)}else{mes_post(res.message);redirect(res.redirect)}})}
change_pm=function(){$t.find('.pm_select .btn').click(function(){let ps=$(this).closest('.pm_select');let d=ps.find('.dropdown');if(ps.hasClass('is-active')){ps.removeClass('is-active');d.hide()}else{let pa=$('.pm_select.is-active');if(pa.length){pa.removeClass('is-active').find('.dropdown').hide()}
ps.addClass('is-active');d.show()}});$('body').click(function(e){let pa=$('.pm_select.is-active');if(!pa.length)return;if(pa.has(e.target).length===0){pa.removeClass('is-active').find('.dropdown').hide()}});$t.find('.pm_select').on('click','.dropdown .option',function(){let option=$(this);$('.pm_select.is-active').removeClass('is-active').find('.dropdown').hide();let pm_select=option.closest('.pm_select');let btn=pm_select.find('.btn');btn.find('.pm_select_img').html(option.find('.pm_select_img').html());btn.find('span').text(option.find('span').text());after_change_option_pm(option,pm_select)});$t.find('.currency_select').on('click','a',function(ev){ev.preventDefault();let cur=$(this);cur.parent().find('.active').removeClass('active');cur.addClass('active');let part=cur.closest('.trade-part');part.find('.amount_input .addons').text(cur.text());let child_id=cur.data('child_id');let type=part.find('.pm_select').hasClass('send')?'send':'get';if(type=='send'){send_child_id=child_id}else{get_child_id=child_id}
set_ids_form();update()})}
update_fields_send=function(id){if(data==null)return;if(typeof data[id]==='undefined'){error(lang.unknown_error);return}
let v=data[id];let html;if(v.comment_send==null)html='';else html='<p>'+v.comment_send+'</p>';$('.exchange_comment').html(html);if(v.account_name&&v.type=='bank'){$('#field_account_send').show();$('#field_account_send .placeholder').text(v.account_name)}else{$('#field_account_send').hide()}
if(v.field_2){let f2=v.field_2.split('|');if(f2.length==2){if(f2[1]!=''){$('#field_account_send_2').show();$('#field_account_send_2 .placeholder').text(f2[1])}else{$('#field_account_send_2').hide()}}else{$('#field_account_send_2').show();$('#field_account_send_2 .placeholder').text(v.field_2)}}else{$('#field_account_send_2').hide()}}
update_fields_recive=function(id){if(data==null)return;if(typeof data[id]==='undefined'){error(lang.unknown_error);return}
let v=data[id];let html;if(v.comment_recive==null)html='';else html='<p class="recive_comment">'+v.comment_recive+'</p>';$('.exchange_comment .recive_comment').remove();if(html!='')$('.exchange_comment').append(html);$('#field_account_recive').show();$('#field_account_recive .placeholder').text(v.account_name);if(v.field_2){let f2=v.field_2.split('|');if(f2.length==2){if(f2[0]!=''){$('#field_account_recive_2').show();$('#field_account_recive_2 .placeholder').text(f2[0])}else{$('#field_account_recive_2').hide()}}else{$('#field_account_recive_2').show();$('#field_account_recive_2 .placeholder').text(v.field_2)}}else{$('#field_account_recive_2').hide()}}
after_change_option_pm=function(option,pm_select){let id=option.data('id');let cur=option.data('cur');let part=pm_select.closest('.trade-part');if(pm_select.hasClass('send')){send_id=id;send_child_id=0;let o=$('#get_option_'+id);$('.pm_select.get .option.hidden').removeClass('hidden');o.addClass('hidden');if(get_id==id){$('.pm_select.get .option:not(.hidden):first').trigger('click')}
update_fields_send(id)}else{get_id=id;get_child_id=0;update_fields_recive(id)}
set_ids_form();let childs='<a href="#" class="active">'+cur+'</a>'+option.find('.pm_childs').html();part.find('.currency_select').html(childs);part.find('.amount_input .addons').text(cur);update()}
init=function(){if($('#exchange_proccess').length){exchange_proccess()}
$t=$('#trade');if(!$t.length)return;$t.submit(function(ev){ev.preventDefault();submit_form()});$btn_submit=$t.find('.btn-submit');$overlay=$t.find('.overlay');$send_id=$('#send_id');$get_id=$('#get_id');$send_child_id=$('#send_child_id');$get_child_id=$('#get_child_id');$rate=$('#rate');$amount_send=$('#amount_send');$amount_get=$('#amount_get');send_id=$send_id.val();get_id=$get_id.val();change_pm();get_rates();$amount_send.on('input',function(){$btn_submit.prop('disabled',!0);let dec=$amount_send.data('decimals');let v=$amount_send.val();v=v.replace(',','.').replace(/[^\d\. ]/g,'');v1=v.replace(/ /g,'');let m=v1.split('.');if(m.length>2){v1=v=m[0]+'.'+m[1];m=v1.split('.')}
if(m.length==2&&m[1].length>dec){let x=m[1].length-dec;v=v1.substring(0,v1.length-x)}
$amount_send.val(v);let res=get_amount_send()*rate;set_amount_get(res)});$amount_get.on('input',function(){$btn_submit.prop('disabled',!0);let dec=$amount_get.data('decimals');let v=$amount_get.val();v=v.replace(',','.').replace(/[^\d\. ]/g,'');v1=v.replace(/ /g,'');let m=v1.split('.');if(m.length>2){v1=v=m[0]+'.'+m[1];m=v1.split('.')}
if(m.length==2&&m[1].length>dec){let x=m[1].length-dec;v=v1.substring(0,v1.length-x)}
$amount_get.val(v);let res=get_amount_get()/rate;set_amount_send(res)});$('#amount_send,#amount_get').on('focus',function(){$btn_submit.prop('disabled',!0)});$('#amount_send,#amount_get').on('blur',function(){let res=get_amount_send();if(res<min||isNaN(res))set_amount_send(min);if(res>max)set_amount_send(max);$amount_send.trigger('input');$amount_get.trigger('input');setTimeout(function(){$btn_submit.prop('disabled',!1)},200)});$('#field_account_recive input').on('input',function(){let v=data[get_id];if(v.type=='bank'){let e=$(this);let v=e.val();let n=v.replace(/[^\d]/g,'');let s='';let len=n.length;let x=parseInt(len/4);for(i=0;i<4;i++){if(x<i)break;s+=n.substr(i*4,4)+' '}
if(x==4)s=s.slice(0,-1);if(len>16&&len<=18)s+=n.substr(16,2);e.val(s)}});$('#field_account_send input').on('input',function(){let v=data[send_id];if(v.type=='bank'){let e=$(this);let v=e.val();let n=v.replace(/[^\d]/g,'');let s='';let len=n.length;let x=parseInt(len/4);for(i=0;i<4;i++){if(x<i)break;s+=n.substr(i*4,4)+' '}
if(x==4)s=s.slice(0,-1);if(len>16&&len<=18)s+=n.substr(16,2);e.val(s)}})}
init()}(Trade||{}))